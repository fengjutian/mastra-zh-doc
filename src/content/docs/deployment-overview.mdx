---
title: 部署概述
description: 了解Mastra应用的部署选项和最佳实践
sidebar_order: 1
category: 部署
---

# 部署概述

Mastra 提供灵活的部署选项，使您可以将智能体和工作流轻松集成到各种环境中。本文档介绍了主要的部署方法和最佳实践。

## 部署选项

Mastra 支持多种部署模式，适应不同的应用场景：

### 1. 集成到现有应用

您可以将 Mastra 智能体和工作流直接集成到现有的 JavaScript/TypeScript 应用中：

- **React 应用**：作为客户端或服务器端组件
- **Next.js 应用**：在 API 路由或服务器组件中使用
- **Node.js 服务**：作为 Express、Fastify 等框架的一部分

### 2. 独立服务部署

使用 Mastra 的部署助手将智能体和工作流打包为独立服务：

- **Node.js 服务**：基于 Hono 的轻量级 HTTP 服务
- **无服务器函数**：部署到 Vercel、Cloudflare Workers、Netlify 等
- **容器化部署**：使用 Docker 容器部署到任何支持容器的平台

## 集成到现有应用

### React 应用集成

```jsx
// src/components/AgentChat.jsx
import { useEffect, useState } from 'react';
import { createAgent } from 'mastra';

export function AgentChat() {
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [agent] = useState(() => createAgent({
    model: 'gpt-4',
    systemPrompt: '你是一个友好的助手'
  }));

  const handleSubmit = async (e) => {
    e.preventDefault();
    const userMessage = { role: 'user', content: input };
    setMessages(prev => [...prev, userMessage]);
    setInput('');

    // 调用智能体
    const response = await agent.chat({ message: input });
    setMessages(prev => [...prev, { role: 'assistant', content: response.content }]);
  };

  return (
    <div className="chat-container">
      <div className="messages">
        {messages.map((msg, index) => (
          <div key={index} className={`message ${msg.role}`}>
            {msg.content}
          </div>
        ))}
      </div>
      <form onSubmit={handleSubmit}>
        <input
          value={input}
          onChange={(e) => setInput(e.target.value)}
          placeholder="输入消息..."
        />
        <button type="submit">发送</button>
      </form>
    </div>
  );
}
```

### Next.js API 路由

```javascript
// pages/api/agent.js
import { createAgent } from 'mastra';

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { message } = req.body;
  if (!message) {
    return res.status(400).json({ error: 'Message is required' });
  }

  try {
    const agent = createAgent({
      model: 'gpt-4',
      systemPrompt: '你是一个专业的技术支持助手'
    });

    const response = await agent.chat({ message });
    res.status(200).json({ response: response.content });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
}
```

## 独立服务部署

### 使用部署助手

Mastra 提供部署助手，简化独立服务的创建和部署：

```typescript
// deploy.js
import { createDeployment } from 'mastra/deploy';

createDeployment({
  entryPoint: './src/agents/index.js',
  outputDir: './dist',
  platform: 'node', // 或 'vercel', 'cloudflare', 'netlify'
  routes: [
    {
      path: '/api/agent',
      agent: 'myAgent',
      method: 'POST'
    },
    {
      path: '/api/workflow',
      workflow: 'myWorkflow',
      method: 'POST'
    }
  ],
  environment: {
    NODE_ENV: 'production',
    OPENAI_API_KEY: process.env.OPENAI_API_KEY
  }
});
```

### Docker 容器化

```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install --production

COPY dist ./dist

EXPOSE 3000

CMD ["node", "dist/server.js"]
```

## 环境配置

### 必需的环境变量

根据您使用的功能，可能需要设置以下环境变量：

```bash
# LLM 提供商凭证
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...
GOOGLE_API_KEY=AIzaSy...

# 向量数据库配置
PINECONE_API_KEY=...
PINECONE_ENVIRONMENT=...

# 可选：监控和可观测性
LANGFUSE_SECRET_KEY=...
BRAINTRUST_API_KEY=...
```

### 部署前检查清单

1. **配置管理**：确保敏感配置（API 密钥等）通过环境变量管理，不硬编码
2. **性能优化**：
   - 配置适当的缓存策略
   - 优化模型调用参数（温度、最大令牌等）
   - 考虑使用流式响应减少感知延迟
3. **错误处理**：实现完善的错误处理和重试机制
4. **监控设置**：配置适当的日志和监控
5. **资源规划**：根据预期流量规划服务器资源

## 扩展和扩展性

### 负载均衡

对于高流量应用，考虑使用负载均衡器分发请求：

- **水平扩展**：部署多个实例并使用负载均衡器
- **会话亲和性**：对于需要保持状态的应用，配置会话亲和性

### 缓存策略

实施多级缓存提高性能：

- **请求缓存**：缓存常见查询的响应
- **嵌入缓存**：缓存频繁使用文本的嵌入向量
- **中间结果缓存**：在复杂工作流中缓存中间步骤的结果

## 下一步

- 了解[部署到特定平台](./platform-specific.mdx)的详细指南
- 学习[性能优化](./performance-optimization.mdx)技巧
- 探索[监控和可观测性](./monitoring.mdx)选项