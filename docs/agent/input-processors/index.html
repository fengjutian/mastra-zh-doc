<!DOCTYPE html><html lang="zh-CN" data-astro-cid-usuvaegl> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Mastra 中文文档" href="https://fengjutian.github.io/rss.xml"><meta name="generator" content="Astro v5.14.1"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://fengjutian.github.io/mastra-zh-doc/docs/agent/input-processors/"><!-- Primary Meta Tags --><title>Input Processors</title><meta name="title" content="Input Processors"><meta name="description" content="Learn how to use input processors to intercept and modify agent messages before they reach the language model."><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://fengjutian.github.io/mastra-zh-doc/docs/agent/input-processors/"><meta property="og:title" content="Input Processors"><meta property="og:description" content="Learn how to use input processors to intercept and modify agent messages before they reach the language model."><meta property="og:image" content="https://fengjutian.github.io/mastra-zh-doc/_astro/blog-placeholder-1.Bx0Zcyzv.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://fengjutian.github.io/mastra-zh-doc/docs/agent/input-processors/"><meta property="twitter:title" content="Input Processors"><meta property="twitter:description" content="Learn how to use input processors to intercept and modify agent messages before they reach the language model."><meta property="twitter:image" content="https://fengjutian.github.io/mastra-zh-doc/_astro/blog-placeholder-1.Bx0Zcyzv.jpg"><style>:root{--accent: #2337ff;--accent-dark: #000d8a;--black: 15, 18, 25;--gray: 96, 115, 159;--gray-light: 229, 233, 240;--gray-dark: 34, 41, 57;--gray-gradient: rgba(var(--gray-light), 50%), #fff;--box-shadow: 0 2px 6px rgba(var(--gray), 25%), 0 8px 24px rgba(var(--gray), 33%), 0 16px 32px rgba(var(--gray), 33%)}@font-face{font-family:Atkinson;src:url(/mastra-zh-doc/fonts/atkinson-regular.woff) format("woff");font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:Atkinson;src:url(/mastra-zh-doc/fonts/atkinson-bold.woff) format("woff");font-weight:700;font-style:normal;font-display:swap}body{font-family:Atkinson,sans-serif;margin:0;padding:0;text-align:left;background:linear-gradient(var(--gray-gradient)) no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:rgb(var(--gray-dark));font-size:20px;line-height:1.7}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{margin:0 0 .5rem;color:rgb(var(--black));line-height:1.2}h1{font-size:1.902em}h2{font-size:1.041em}h3{font-size:.653em}h4{font-size:.363em}h5{font-size:.05em}strong,b{font-weight:700}a,a:hover{color:var(--accent)}p{margin-bottom:1em}.prose p{margin-bottom:2em}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:2px 5px;background-color:rgb(var(--gray-light));border-radius:2px}pre{padding:1.5em;border-radius:8px}pre>code{all:unset}blockquote{border-left:4px solid var(--accent);padding:0 0 0 20px;margin:0;font-size:.833em}hr{border:none;border-top:1px solid rgb(var(--gray-light))}@media (max-width: 720px){body{font-size:18px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 1em;background:#fff;box-shadow:0 2px 8px rgba(var(--black),5%)}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2],h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em;color:var(--black);border-bottom:4px solid transparent;text-decoration:none}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none;border-bottom-color:var(--accent)}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex}@media (max-width: 720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}
main[data-astro-cid-usuvaegl]{width:1620px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}.docs-layout[data-astro-cid-usuvaegl]{display:flex;gap:2rem;max-width:1400px;margin:auto;padding:1em 1em 3em}.content-container[data-astro-cid-usuvaegl]{display:flex;gap:2rem;flex:1}.sidebar[data-astro-cid-usuvaegl]{width:280px;flex-shrink:0;position:sticky;top:2rem;max-height:calc(100vh - 4rem);overflow-y:auto;padding-right:1rem;font-size:.9rem}.sidebar[data-astro-cid-usuvaegl] h2[data-astro-cid-usuvaegl]{margin-bottom:1rem;color:rgb(var(--black));font-size:1.5em}.sidebar[data-astro-cid-usuvaegl] h3[data-astro-cid-usuvaegl]{margin:1.5rem 0 .75rem;color:rgb(var(--gray));font-weight:500;font-size:1.1em}.sidebar[data-astro-cid-usuvaegl] ul[data-astro-cid-usuvaegl]{list-style:none;padding:0;margin:0}.sidebar[data-astro-cid-usuvaegl] li[data-astro-cid-usuvaegl]{margin:.35rem 0}.sidebar[data-astro-cid-usuvaegl] a[data-astro-cid-usuvaegl]{display:block;padding:.5rem;color:rgb(var(--gray-dark));text-decoration:none;border-radius:.375rem;transition:background-color .2s}.sidebar[data-astro-cid-usuvaegl] a[data-astro-cid-usuvaegl]:hover{background-color:rgba(var(--gray-light),70%)}.sidebar[data-astro-cid-usuvaegl] a[data-astro-cid-usuvaegl].active{background-color:#2337ff1a;color:var(--accent);font-weight:500}.content[data-astro-cid-usuvaegl]{flex:1;max-width:1200px}.right-sidebar[data-astro-cid-usuvaegl]{width:280px;flex-shrink:0;position:sticky;top:2rem;max-height:calc(100vh - 4rem);overflow-y:auto;padding-left:1rem;border-left:1px solid rgba(var(--gray-light),100%);font-size:.9rem}.right-sidebar[data-astro-cid-usuvaegl] h3[data-astro-cid-usuvaegl]{margin-top:0;margin-bottom:1rem;color:rgb(var(--black));font-size:1.1em}.toc-list[data-astro-cid-usuvaegl]{list-style:none;padding:0;margin:0}.toc-list[data-astro-cid-usuvaegl] li[data-astro-cid-usuvaegl]{margin:.35rem 0}.toc-list[data-astro-cid-usuvaegl] a[data-astro-cid-usuvaegl]{display:block;padding:.35rem 0;color:rgb(var(--gray-dark));text-decoration:none;transition:color .2s}.toc-list[data-astro-cid-usuvaegl] a[data-astro-cid-usuvaegl]:hover{color:var(--accent)}.toc-item-h2[data-astro-cid-usuvaegl]{margin-left:0}.toc-item-h3[data-astro-cid-usuvaegl]{margin-left:1rem;font-size:.95em}.toc-item-h4[data-astro-cid-usuvaegl]{margin-left:2rem;font-size:.9em}.content[data-astro-cid-usuvaegl] .description[data-astro-cid-usuvaegl]{margin-bottom:2em;color:rgb(var(--gray))}@media (max-width: 1024px){.sidebar[data-astro-cid-usuvaegl]{width:240px}}@media (max-width: 1200px){.right-sidebar[data-astro-cid-usuvaegl]{width:240px}}@media (max-width: 1024px){.sidebar[data-astro-cid-usuvaegl]{width:240px}.content-container[data-astro-cid-usuvaegl]{flex-direction:column}.right-sidebar[data-astro-cid-usuvaegl]{width:100%;position:static;max-height:none;overflow-y:visible;padding-left:0;border-left:none;border-top:1px solid rgba(var(--gray-light),100%);padding-top:1rem;margin-top:1rem}}@media (max-width: 768px){.docs-layout[data-astro-cid-usuvaegl]{flex-direction:column;gap:1rem}.sidebar[data-astro-cid-usuvaegl]{width:100%;position:static;max-height:none;overflow-y:visible;padding-right:0;margin-bottom:1rem}}
a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}
</style></head> <body data-astro-cid-usuvaegl> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <h2 data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2>Mastra 中文文档</a></h2> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Home </a>  <a href="/docs" class="active" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Docs </a>  <a href="/blog" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Blog </a>  <a href="/about" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> About </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://m.webtoo.ls/@astro" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Follow Astro on Mastodon</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://twitter.com/astrodotbuild" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Follow Astro on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://github.com/withastro/astro" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Astro's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> </div> </nav> </header>  <main data-astro-cid-usuvaegl> <div class="docs-layout" data-astro-cid-usuvaegl> <!-- 左侧文档导航 --> <div class="sidebar" data-astro-cid-usuvaegl> <h2 style="margin-top: 0;" data-astro-cid-usuvaegl>Mastra 文档目录</h2> <div data-astro-cid-usuvaegl> <h3 data-astro-cid-usuvaegl>Mastra</h3> <ul data-astro-cid-usuvaegl> <li data-astro-cid-usuvaegl> <a href="/docs/mastra/mastra-getting-started" class data-astro-cid-usuvaegl> 简介 | Mastra 文档 </a> </li><li data-astro-cid-usuvaegl> <a href="/docs/mastra/mastra-project-structure" class data-astro-cid-usuvaegl> 项目结构 </a> </li><li data-astro-cid-usuvaegl> <a href="/docs/mastra/mcp-docs-server" class data-astro-cid-usuvaegl> Mastra MCP 文档服务器 </a> </li><li data-astro-cid-usuvaegl> <a href="/docs/mastra/model-providers" class data-astro-cid-usuvaegl> 模型提供者（Model Providers） </a> </li><li data-astro-cid-usuvaegl> <a href="/docs/mastra/model-capability" class data-astro-cid-usuvaegl> 模型能力（Model Capabilities） </a> </li><li data-astro-cid-usuvaegl> <a href="/docs/mastra/templates" class data-astro-cid-usuvaegl>  模板（Templates） </a> </li> </ul> </div><div data-astro-cid-usuvaegl> <h3 data-astro-cid-usuvaegl>部署</h3> <ul data-astro-cid-usuvaegl> <li data-astro-cid-usuvaegl> <a href="/docs/deployment-overview" class data-astro-cid-usuvaegl> 部署概述 </a> </li> </ul> </div><div data-astro-cid-usuvaegl> <h3 data-astro-cid-usuvaegl>工作流</h3> <ul data-astro-cid-usuvaegl> <li data-astro-cid-usuvaegl> <a href="/docs/workflows-overview" class data-astro-cid-usuvaegl> 工作流概述 </a> </li> </ul> </div><div data-astro-cid-usuvaegl> <h3 data-astro-cid-usuvaegl>智能体</h3> <ul data-astro-cid-usuvaegl> <li data-astro-cid-usuvaegl> <a href="/docs/agents-overview" class data-astro-cid-usuvaegl> 智能体概述 </a> </li><li data-astro-cid-usuvaegl> <a href="/docs/agent/adding-voice" class data-astro-cid-usuvaegl> 为智能体添加语音功能 </a> </li><li data-astro-cid-usuvaegl> <a href="/docs/agent/agent-memory" class data-astro-cid-usuvaegl> Using Agent Memory | Agents | Mastra Docs </a> </li><li data-astro-cid-usuvaegl> <a href="/docs/agent/dynamic-agents" class data-astro-cid-usuvaegl> Dynamic Agents </a> </li><li data-astro-cid-usuvaegl> <a href="/docs/agent/output-processors" class data-astro-cid-usuvaegl> Output Processors </a> </li><li data-astro-cid-usuvaegl> <a href="/docs/agent/input-processors" class="active" data-astro-cid-usuvaegl> Input Processors </a> </li><li data-astro-cid-usuvaegl> <a href="/docs/agent/overview" class data-astro-cid-usuvaegl> overview </a> </li><li data-astro-cid-usuvaegl> <a href="/docs/agent/using-tools-and-mcp" class data-astro-cid-usuvaegl> Using Tools with Agents | Agents | Mastra Docs </a> </li><li data-astro-cid-usuvaegl> <a href="/docs/agent/runtime-context" class data-astro-cid-usuvaegl> Runtime context | Agents | Mastra Docs </a> </li> </ul> </div><div data-astro-cid-usuvaegl> <h3 data-astro-cid-usuvaegl>RAG</h3> <ul data-astro-cid-usuvaegl> <li data-astro-cid-usuvaegl> <a href="/docs/rag-overview" class data-astro-cid-usuvaegl> 检索增强生成(RAG)概述 </a> </li> </ul> </div>  </div> <!-- 内容和右侧目录容器 --> <div class="content-container" data-astro-cid-usuvaegl> <!-- 主要内容区域 --> <div class="content" data-astro-cid-usuvaegl> <article data-astro-cid-usuvaegl> <h1 data-astro-cid-usuvaegl>Input Processors</h1> <p class="description" style="color: #666; font-size: 1.125rem; margin-bottom: 2rem;" data-astro-cid-usuvaegl> Learn how to use input processors to intercept and modify agent messages before they reach the language model. </p> <h1 id="input-processors">Input Processors</h1>
<p>Input Processors allow you to intercept, modify, validate, or filter messages <em>before</em> they are sent to the language model. This is useful for implementing guardrails, content moderation, message transformation, and security controls.</p>
<p>Processors operate on the messages in your conversation thread. They can modify, filter, or validate content, and even abort the request entirely if certain conditions are met.</p>
<h2 id="built-in-processors">Built-in Processors</h2>
<p>Mastra provides several built-in processors for common use cases:</p>
<h3 id="unicodenormalizer"><code>UnicodeNormalizer</code></h3>
<p>This processor normalizes Unicode text to ensure consistent formatting and remove potentially problematic characters.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { Agent } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> &quot;@mastra/core/agent&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { UnicodeNormalizer } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> &quot;@mastra/core/processors&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { openai } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> &quot;@ai-sdk/openai&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> agent</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Agent</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">  name: </span><span style="color:#9ECBFF">&#39;normalized-agent&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  instructions: </span><span style="color:#9ECBFF">&#39;You are a helpful assistant&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  model: </span><span style="color:#B392F0">openai</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;gpt-4o&quot;</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">  inputProcessors: [</span></span>
<span class="line"><span style="color:#F97583">    new</span><span style="color:#B392F0"> UnicodeNormalizer</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">      stripControlChars: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      collapseWhitespace: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    }),</span></span>
<span class="line"><span style="color:#E1E4E8">  ],</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<p>Available options:</p>
<ul>
<li><code>stripControlChars</code>: Remove control characters (default: false)</li>
<li><code>preserveEmojis</code>: Keep emojis intact (default: true)</li>
<li><code>collapseWhitespace</code>: Collapse multiple spaces/newlines (default: true)</li>
<li><code>trim</code>: Remove leading/trailing whitespace (default: true)</li>
</ul>
<h3 id="moderationprocessor"><code>ModerationProcessor</code></h3>
<p>This processor provides content moderation using an LLM to detect inappropriate content across multiple categories.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { ModerationProcessor } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> &quot;@mastra/core/processors&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> agent</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Agent</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">  inputProcessors: [</span></span>
<span class="line"><span style="color:#F97583">    new</span><span style="color:#B392F0"> ModerationProcessor</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">      model: </span><span style="color:#B392F0">openai</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;gpt-4.1-nano&quot;</span><span style="color:#E1E4E8">), </span><span style="color:#6A737D">// Use a fast, cost-effective model</span></span>
<span class="line"><span style="color:#E1E4E8">      threshold: </span><span style="color:#79B8FF">0.7</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// Confidence threshold for flagging</span></span>
<span class="line"><span style="color:#E1E4E8">      strategy: </span><span style="color:#9ECBFF">&#39;block&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// Block flagged content</span></span>
<span class="line"><span style="color:#E1E4E8">      categories: [</span><span style="color:#9ECBFF">&#39;hate&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;harassment&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;violence&#39;</span><span style="color:#E1E4E8">], </span><span style="color:#6A737D">// Custom categories</span></span>
<span class="line"><span style="color:#E1E4E8">    }),</span></span>
<span class="line"><span style="color:#E1E4E8">  ],</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<p>Available options:</p>
<ul>
<li><code>model</code>: Language model for moderation analysis (required)</li>
<li><code>categories</code>: Array of categories to check (default: [‘hate’,‘hate/threatening’,‘harassment’,‘harassment/threatening’,‘self-harm’,‘self-harm/intent’,‘self-harm/instructions’,‘sexual’,‘sexual/minors’,‘violence’,‘violence/graphic’])</li>
<li><code>threshold</code>: Confidence threshold for flagging (0-1, default: 0.5)</li>
<li><code>strategy</code>: Action when content is flagged (default: ‘block’)</li>
<li><code>customInstructions</code>: Custom instructions for the moderation agent</li>
</ul>
<p>Strategies available:</p>
<ul>
<li><code>block</code>: Reject the request with an error (default)</li>
<li><code>warn</code>: Log warning but allow content through</li>
<li><code>filter</code>: Remove flagged messages but continue processing</li>
</ul>
<h3 id="promptinjectiondetector"><code>PromptInjectionDetector</code></h3>
<p>This processor detects and prevents prompt injection attacks, jailbreaks, and system manipulation attempts.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { PromptInjectionDetector } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> &quot;@mastra/core/processors&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> agent</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Agent</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">  inputProcessors: [</span></span>
<span class="line"><span style="color:#F97583">    new</span><span style="color:#B392F0"> PromptInjectionDetector</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">      model: </span><span style="color:#B392F0">openai</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;gpt-4.1-nano&quot;</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">      threshold: </span><span style="color:#79B8FF">0.8</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// Higher threshold for fewer false positives</span></span>
<span class="line"><span style="color:#E1E4E8">      strategy: </span><span style="color:#9ECBFF">&#39;rewrite&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// Attempt to neutralize while preserving intent</span></span>
<span class="line"><span style="color:#E1E4E8">      detectionTypes: [</span><span style="color:#9ECBFF">&#39;injection&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;jailbreak&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;system-override&#39;</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">    }),</span></span>
<span class="line"><span style="color:#E1E4E8">  ],</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<p>Available options:</p>
<ul>
<li><code>model</code>: Language model for injection detection (required)</li>
<li><code>detectionTypes</code>: Array of injection types to detect (default: [‘injection’, ‘jailbreak’, ‘system-override’])</li>
<li><code>threshold</code>: Confidence threshold for flagging (0-1, default: 0.7)</li>
<li><code>strategy</code>: Action when injection is detected (default: ‘block’)</li>
<li><code>instructions</code>: Custom detection instructions for the agent</li>
<li><code>includeScores</code>: Whether to include confidence scores in logs (default: false)</li>
</ul>
<p>Strategies available:</p>
<ul>
<li><code>block</code>: Reject the request (default)</li>
<li><code>warn</code>: Log warning but allow through</li>
<li><code>filter</code>: Remove flagged messages</li>
<li><code>rewrite</code>: Attempt to neutralize the injection while preserving legitimate intent</li>
</ul>
<h3 id="piidetector"><code>PIIDetector</code></h3>
<p>This processor detects and optionally redacts personally identifiable information (PII) from messages.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { PIIDetector } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> &quot;@mastra/core/processors&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> agent</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Agent</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">  inputProcessors: [</span></span>
<span class="line"><span style="color:#F97583">    new</span><span style="color:#B392F0"> PIIDetector</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">      model: </span><span style="color:#B392F0">openai</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;gpt-4.1-nano&quot;</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">      threshold: </span><span style="color:#79B8FF">0.6</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      strategy: </span><span style="color:#9ECBFF">&#39;redact&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// Automatically redact detected PII</span></span>
<span class="line"><span style="color:#E1E4E8">      detectionTypes: [</span><span style="color:#9ECBFF">&#39;email&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;phone&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;credit-card&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;ssn&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;api-key&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;crypto-wallet&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;iban&#39;</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">      redactionMethod: </span><span style="color:#9ECBFF">&#39;mask&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// Preserve format while masking</span></span>
<span class="line"><span style="color:#E1E4E8">      preserveFormat: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// Keep original structure in redacted values</span></span>
<span class="line"><span style="color:#E1E4E8">      includeDetections: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// Log details for compliance auditing</span></span>
<span class="line"><span style="color:#E1E4E8">    }),</span></span>
<span class="line"><span style="color:#E1E4E8">  ],</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<p>Available options:</p>
<ul>
<li><code>model</code>: Language model for PII detection (required)</li>
<li><code>detectionTypes</code>: Array of PII types to detect (default: [‘email’, ‘phone’, ‘credit-card’, ‘ssn’, ‘api-key’, ‘ip-address’, ‘name’, ‘address’, ‘date-of-birth’, ‘url’, ‘uuid’, ‘crypto-wallet’, ‘iban’])</li>
<li><code>threshold</code>: Confidence threshold for flagging (0-1, default: 0.6)</li>
<li><code>strategy</code>: Action when PII is detected (default: ‘block’)</li>
<li><code>redactionMethod</code>: How to redact PII (‘mask’, ‘hash’, ‘remove’, ‘placeholder’, default: ‘mask’)</li>
<li><code>preserveFormat</code>: Maintain PII structure during redaction (default: true)</li>
<li><code>includeDetections</code>: Include detection details in logs for compliance (default: false)</li>
<li><code>instructions</code>: Custom detection instructions for the agent</li>
</ul>
<p>Strategies available:</p>
<ul>
<li><code>block</code>: Reject requests containing PII (default)</li>
<li><code>warn</code>: Log warning but allow through</li>
<li><code>filter</code>: Remove messages containing PII</li>
<li><code>redact</code>: Replace PII with placeholder values</li>
</ul>
<h3 id="languagedetector"><code>LanguageDetector</code></h3>
<p>This processor detects the language of incoming messages and can automatically translate them to a target language.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { LanguageDetector } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> &quot;@mastra/core/processors&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> agent</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Agent</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">  inputProcessors: [</span></span>
<span class="line"><span style="color:#F97583">    new</span><span style="color:#B392F0"> LanguageDetector</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">      model: </span><span style="color:#B392F0">openai</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;gpt-4o-mini&quot;</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">      targetLanguages: [</span><span style="color:#9ECBFF">&#39;English&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;en&#39;</span><span style="color:#E1E4E8">], </span><span style="color:#6A737D">// Accept English content</span></span>
<span class="line"><span style="color:#E1E4E8">      strategy: </span><span style="color:#9ECBFF">&#39;translate&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// Auto-translate non-English content</span></span>
<span class="line"><span style="color:#E1E4E8">      threshold: </span><span style="color:#79B8FF">0.8</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// High confidence threshold</span></span>
<span class="line"><span style="color:#E1E4E8">    }),</span></span>
<span class="line"><span style="color:#E1E4E8">  ],</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<p>Available options:</p>
<ul>
<li><code>model</code>: Language model for detection and translation (required)</li>
<li><code>targetLanguages</code>: Array of target languages (language names or ISO codes)</li>
<li><code>threshold</code>: Confidence threshold for language detection (0-1, default: 0.7)</li>
<li><code>strategy</code>: Action when non-target language is detected (default: ‘detect’)</li>
<li><code>preserveOriginal</code>: Keep original content in metadata (default: true)</li>
<li><code>instructions</code>: Custom detection instructions for the agent</li>
</ul>
<p>Strategies available:</p>
<ul>
<li><code>detect</code>: Only detect language, don’t translate (default)</li>
<li><code>translate</code>: Automatically translate to target language</li>
<li><code>block</code>: Reject content not in target language</li>
<li><code>warn</code>: Log warning but allow content through</li>
</ul>
<h2 id="applying-multiple-processors">Applying Multiple Processors</h2>
<p>You can chain multiple processors. They execute sequentially in the order they appear in the <code>inputProcessors</code> array. The output of one processor becomes the input for the next.</p>
<p><strong>Order matters!</strong> Generally, it’s best practice to place text normalization first, security checks next, and content modification last.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { Agent } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> &quot;@mastra/core/agent&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">  UnicodeNormalizer,</span></span>
<span class="line"><span style="color:#E1E4E8">  ModerationProcessor,</span></span>
<span class="line"><span style="color:#E1E4E8">  PromptInjectionDetector,</span></span>
<span class="line"><span style="color:#E1E4E8">  PIIDetector</span></span>
<span class="line"><span style="color:#E1E4E8">} </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> &quot;@mastra/core/processors&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> secureAgent</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Agent</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">  inputProcessors: [</span></span>
<span class="line"><span style="color:#6A737D">    // 1. Normalize text first</span></span>
<span class="line"><span style="color:#F97583">    new</span><span style="color:#B392F0"> UnicodeNormalizer</span><span style="color:#E1E4E8">({ stripControlChars: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8"> }),</span></span>
<span class="line"><span style="color:#6A737D">    // 2. Check for security threats</span></span>
<span class="line"><span style="color:#F97583">    new</span><span style="color:#B392F0"> PromptInjectionDetector</span><span style="color:#E1E4E8">({ model: </span><span style="color:#B392F0">openai</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;gpt-4.1-nano&quot;</span><span style="color:#E1E4E8">) }),</span></span>
<span class="line"><span style="color:#6A737D">    // 3. Moderate content</span></span>
<span class="line"><span style="color:#F97583">    new</span><span style="color:#B392F0"> ModerationProcessor</span><span style="color:#E1E4E8">({ model: </span><span style="color:#B392F0">openai</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;gpt-4.1-nano&quot;</span><span style="color:#E1E4E8">) }),</span></span>
<span class="line"><span style="color:#6A737D">    // 4. Handle PII last</span></span>
<span class="line"><span style="color:#F97583">    new</span><span style="color:#B392F0"> PIIDetector</span><span style="color:#E1E4E8">({ model: </span><span style="color:#B392F0">openai</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;gpt-4.1-nano&quot;</span><span style="color:#E1E4E8">), strategy: </span><span style="color:#9ECBFF">&#39;redact&#39;</span><span style="color:#E1E4E8"> }),</span></span>
<span class="line"><span style="color:#E1E4E8">  ],</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<h2 id="creating-custom-processors">Creating Custom Processors</h2>
<p>You can create custom processors by implementing the <code>Processor</code> interface. A Processor can be used for input processing when it implements the <code>processInput</code> method.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#F97583"> type</span><span style="color:#E1E4E8"> { Processor } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> &quot;@mastra/core/processors&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#F97583"> type</span><span style="color:#E1E4E8"> { MastraMessageV2 } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> &quot;@mastra/core/agent/message-list&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { TripWire } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> &quot;@mastra/core/agent&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> MessageLengthLimiter</span><span style="color:#F97583"> implements</span><span style="color:#B392F0"> Processor</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  readonly</span><span style="color:#FFAB70"> name</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> &#39;message-length-limiter&#39;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  constructor</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">private</span><span style="color:#FFAB70"> maxLength</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 1000</span><span style="color:#E1E4E8">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  processInput</span><span style="color:#E1E4E8">({ </span><span style="color:#FFAB70">messages</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">abort</span><span style="color:#E1E4E8"> }</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">    messages</span><span style="color:#F97583">:</span><span style="color:#B392F0"> MastraMessageV2</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#B392F0">    abort</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">reason</span><span style="color:#F97583">?:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=&gt;</span><span style="color:#79B8FF"> never</span></span>
<span class="line"><span style="color:#E1E4E8">  })</span><span style="color:#F97583">:</span><span style="color:#B392F0"> MastraMessageV2</span><span style="color:#E1E4E8">[] {</span></span>
<span class="line"><span style="color:#6A737D">    // Check total message length</span></span>
<span class="line"><span style="color:#F97583">    try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">      const</span><span style="color:#79B8FF"> totalLength</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> messages.</span><span style="color:#B392F0">reduce</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">sum</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">msg</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> sum </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> msg.content.parts</span></span>
<span class="line"><span style="color:#E1E4E8">          .</span><span style="color:#B392F0">filter</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">part</span><span style="color:#F97583"> =&gt;</span><span style="color:#E1E4E8"> part.type </span><span style="color:#F97583">===</span><span style="color:#9ECBFF"> &#39;text&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">          .</span><span style="color:#B392F0">reduce</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">partSum</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">part</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> partSum </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> (part </span><span style="color:#F97583">as</span><span style="color:#79B8FF"> any</span><span style="color:#E1E4E8">).text.</span><span style="color:#79B8FF">length</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">      }, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (totalLength </span><span style="color:#F97583">&gt;</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.maxLength) {</span></span>
<span class="line"><span style="color:#B392F0">        abort</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`Message too long: ${</span><span style="color:#E1E4E8">totalLength</span><span style="color:#9ECBFF">} characters (max: ${</span><span style="color:#79B8FF">this</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">maxLength</span><span style="color:#9ECBFF">})`</span><span style="color:#E1E4E8">); </span><span style="color:#6A737D">// throws a TripWire error</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (error) {</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (error </span><span style="color:#F97583">instanceof</span><span style="color:#B392F0"> TripWire</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">        throw</span><span style="color:#E1E4E8"> error; </span><span style="color:#6A737D">// Re-throw tripwire errors</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#F97583">      throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`Length validation failed: ${</span><span style="color:#E1E4E8">error</span><span style="color:#F97583"> instanceof</span><span style="color:#B392F0"> Error</span><span style="color:#F97583"> ?</span><span style="color:#E1E4E8"> error</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">message</span><span style="color:#F97583"> :</span><span style="color:#9ECBFF"> &#39;Unknown error&#39;}`</span><span style="color:#E1E4E8">); </span><span style="color:#6A737D">// application level throw a standard error</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> messages;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Use the custom processor</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> agent</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Agent</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">  inputProcessors: [</span></span>
<span class="line"><span style="color:#F97583">    new</span><span style="color:#B392F0"> MessageLengthLimiter</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">2000</span><span style="color:#E1E4E8">), </span><span style="color:#6A737D">// Limit to 2000 characters</span></span>
<span class="line"><span style="color:#E1E4E8">  ],</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<p>When creating custom processors:</p>
<ul>
<li>Always return the <code>messages</code> array (potentially modified)</li>
<li>Use <code>abort(reason)</code> to terminate processing early. Abort is used to simulate blocking a message. errors thrown with <code>abort</code> will be an instance of TripWire. For code/application level errors, throw standard errors.</li>
<li>Mutate the input messages directly, make sure to mutate both the parts and content of a message.</li>
<li>Keep processors focused on a single responsibility</li>
<li>If using an agent inside your processor, use a fast model, limit the size of the response from it as much as possible (every token slows down the response exponentially), and make the system prompt as concise as possible, these are both latency bottlenecks.</li>
</ul>
<h2 id="integration-with-agent-methods">Integration with Agent Methods</h2>
<p>Input processors work with the <code>generate()</code>, <code>stream()</code>, and <code>streamVNext()</code> methods. The entire processor pipeline completes before the agent begins generating or streaming a response.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#6A737D">// Processors run before generate()</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> result</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> agent.</span><span style="color:#B392F0">generate</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;Hello&#39;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Processors also run before streamVNext()</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> stream</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> agent.</span><span style="color:#B392F0">streamVNext</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;Hello&#39;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">for</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">const</span><span style="color:#79B8FF"> chunk</span><span style="color:#F97583"> of</span><span style="color:#E1E4E8"> stream) {</span></span>
<span class="line"><span style="color:#E1E4E8">  console.</span><span style="color:#B392F0">log</span><span style="color:#E1E4E8">(chunk);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>If any processor calls <code>abort()</code>, the request terminates immediately and subsequent processors are not executed. The agent returns a 200 response with details (<code>result.tripwireReason</code>) about why the request was blocked.</p>
<h2 id="output-processors">Output Processors</h2>
<p>While input processors handle user messages before they reach the language model, <strong>output processors</strong> handle the LLM’s responses after generation but before they’re returned to the user. This is useful for response validation, content filtering, and safety controls on LLM-generated content.</p>
<p>See the <a href="/docs/agents/output-processors">Output Processors documentation</a> for details on processing LLM responses.</p> </article> </div> </div> <!-- 右侧文档内目录 --> <div class="right-sidebar" data-astro-cid-usuvaegl> <h3 data-astro-cid-usuvaegl>文档目录</h3> <ul class="toc-list" data-astro-cid-usuvaegl> <li class="toc-item-h2" data-astro-cid-usuvaegl> <a href="#built-in-processors" data-astro-cid-usuvaegl>Built-in Processors</a> </li><li class="toc-item-h3" data-astro-cid-usuvaegl> <a href="#unicodenormalizer" data-astro-cid-usuvaegl>UnicodeNormalizer</a> </li><li class="toc-item-h3" data-astro-cid-usuvaegl> <a href="#moderationprocessor" data-astro-cid-usuvaegl>ModerationProcessor</a> </li><li class="toc-item-h3" data-astro-cid-usuvaegl> <a href="#promptinjectiondetector" data-astro-cid-usuvaegl>PromptInjectionDetector</a> </li><li class="toc-item-h3" data-astro-cid-usuvaegl> <a href="#piidetector" data-astro-cid-usuvaegl>PIIDetector</a> </li><li class="toc-item-h3" data-astro-cid-usuvaegl> <a href="#languagedetector" data-astro-cid-usuvaegl>LanguageDetector</a> </li><li class="toc-item-h2" data-astro-cid-usuvaegl> <a href="#applying-multiple-processors" data-astro-cid-usuvaegl>Applying Multiple Processors</a> </li><li class="toc-item-h2" data-astro-cid-usuvaegl> <a href="#creating-custom-processors" data-astro-cid-usuvaegl>Creating Custom Processors</a> </li><li class="toc-item-h2" data-astro-cid-usuvaegl> <a href="#integration-with-agent-methods" data-astro-cid-usuvaegl>Integration with Agent Methods</a> </li><li class="toc-item-h2" data-astro-cid-usuvaegl> <a href="#output-processors" data-astro-cid-usuvaegl>Output Processors</a> </li> </ul> </div> </div> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2025 Your name here. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte> <a href="https://m.webtoo.ls/@astro" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Astro on Mastodon</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/mastodon" data-astro-cid-sz7xmlte><path fill="currentColor" d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://twitter.com/astrodotbuild" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Astro on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-sz7xmlte><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://github.com/withastro/astro" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Astro's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> </div> </footer>  </body></html>